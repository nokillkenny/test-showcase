name: Publish Reports

on:
  repository_dispatch:
    types: [test-completed]
  workflow_dispatch:
    inputs:
      repo:
        description: 'Source repo (playwright-showcase, ruby-cucumber-capybara-example, codeceptjs-rest-bdd)'
        required: true
        type: choice
        options:
          - playwright-showcase
          - ruby-cucumber-capybara-example
          - codeceptjs-rest-bdd

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
        continue-on-error: true

      - name: Setup gh-pages branch
        run: |
          git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages
          git reset --hard || true

      - name: Map repo to directory
        id: info
        run: |
          REPO="${{ github.event.client_payload.repo || github.event.inputs.repo }}"
          TIMESTAMP=$(date -u +%Y-%m-%d-%H%M)
          
          case "$REPO" in
            playwright-showcase) DIR="playwright"; ARTIFACT="playwright-report" ;;
            ruby-cucumber-capybara-example) DIR="ruby-cucumber"; ARTIFACT="cucumber-report" ;;
            codeceptjs-rest-bdd) DIR="codeceptjs"; ARTIFACT="codeceptjs-report" ;;
            *) echo "Unknown repo: $REPO"; exit 1 ;;
          esac
          
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "dir=$DIR" >> $GITHUB_OUTPUT
          echo "artifact=$ARTIFACT" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.SHOWCASE_PAT }}
          repo: nokillkenny/${{ steps.info.outputs.repo }}
          workflow: test.yml
          name: ${{ steps.info.outputs.artifact }}
          path: ${{ steps.info.outputs.dir }}/${{ steps.info.outputs.timestamp }}/
          workflow_conclusion: ''

      - name: Normalize report structure
        run: |
          DIR="${{ steps.info.outputs.dir }}/${{ steps.info.outputs.timestamp }}"
          # Rename any .html file to index.html if no index.html exists
          if [ ! -f "$DIR/index.html" ]; then
            HTML_FILE=$(find "$DIR" -maxdepth 1 -name "*.html" | head -1)
            [ -n "$HTML_FILE" ] && mv "$HTML_FILE" "$DIR/index.html"
          fi

      - name: Generate index pages
        run: |
          # Shared styles with theme support
          STYLES='<style>
          :root{--bg:#0a0a0a;--fg:#e0e0e0;--accent:#00ff88}
          :root.light{--bg:#fdf6e3;--fg:#657b83;--accent:#859900}
          body{font-family:monospace;background:var(--bg);color:var(--fg);max-width:600px;margin:2rem auto;padding:1rem}
          a{color:var(--accent)}h1{color:var(--accent)}
          </style>
          <script>const p=new URLSearchParams(location.search);if(p.get("theme")==="light")document.documentElement.classList.add("light")</script>'

          # Root index
          cat > index.html << EOF
          <!DOCTYPE html>
          <html><head><title>Test Reports</title>
          $STYLES
          </head><body>
          <h1>\$ ls ./reports</h1>
          <ul>
            <li><a href="playwright/">playwright/</a></li>
            <li><a href="ruby-cucumber/">ruby-cucumber/</a></li>
            <li><a href="codeceptjs/">codeceptjs/</a></li>
          </ul>
          </body></html>
          EOF

          # Per-framework index
          for dir in playwright ruby-cucumber codeceptjs; do
            mkdir -p "$dir"
            cat > "$dir/index.html" << EOF
          <!DOCTYPE html>
          <html><head><title>$dir</title>
          $STYLES
          </head><body>
          <h1>\$ ls ./$dir</h1>
          <p><a href="../">‚Üê ..</a></p><ul>
          EOF
            for run in $(ls -dr "$dir"/2* 2>/dev/null | head -20); do
              echo "<li><a href=\"$(basename $run)/\">$(basename $run)/</a></li>" >> "$dir/index.html"
            done
            echo '</ul></body></html>' >> "$dir/index.html"
          done

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Add ${{ steps.info.outputs.dir }} report ${{ steps.info.outputs.timestamp }}"
          git push origin gh-pages --force
