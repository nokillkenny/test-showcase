name: Publish Reports

on:
  repository_dispatch:
    types: [test-completed]
  workflow_dispatch:
    inputs:
      repo:
        description: 'Source repo (playwright-showcase, ruby-cucumber-capybara-example, codeceptjs-rest-bdd)'
        required: true
        type: choice
        options:
          - playwright-showcase
          - ruby-cucumber-capybara-example
          - codeceptjs-rest-bdd

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
        continue-on-error: true

      - name: Setup gh-pages branch
        run: |
          git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages
          git reset --hard || true

      - name: Map repo to directory
        id: info
        run: |
          REPO="${{ github.event.client_payload.repo || github.event.inputs.repo }}"
          TIMESTAMP=$(date -u +%Y-%m-%d-%H%M)
          
          case "$REPO" in
            playwright-showcase) DIR="playwright"; ARTIFACT="playwright-report" ;;
            ruby-cucumber-capybara-example) DIR="ruby-cucumber"; ARTIFACT="cucumber-report" ;;
            codeceptjs-rest-bdd) DIR="codeceptjs"; ARTIFACT="codeceptjs-report" ;;
            *) echo "Unknown repo: $REPO"; exit 1 ;;
          esac
          
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "dir=$DIR" >> $GITHUB_OUTPUT
          echo "artifact=$ARTIFACT" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.SHOWCASE_PAT }}
          repo: nokillkenny/${{ steps.info.outputs.repo }}
          workflow: test.yml
          name: ${{ steps.info.outputs.artifact }}
          path: ${{ steps.info.outputs.dir }}/${{ steps.info.outputs.timestamp }}/

      - name: Generate index pages
        run: |
          # Root index
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html><head><title>Test Reports</title>
          <style>body{font-family:monospace;background:#0a0a0a;color:#e0e0e0;max-width:600px;margin:2rem auto;padding:1rem}a{color:#00ff88}h1{color:#00ff88}</style>
          </head><body>
          <h1>$ ls ./reports</h1>
          <ul>
            <li><a href="playwright/">playwright/</a></li>
            <li><a href="ruby-cucumber/">ruby-cucumber/</a></li>
            <li><a href="codeceptjs/">codeceptjs/</a></li>
          </ul>
          </body></html>
          EOF

          # Per-framework index
          for dir in playwright ruby-cucumber codeceptjs; do
            mkdir -p "$dir"
            cat > "$dir/index.html" << EOF
          <!DOCTYPE html>
          <html><head><title>$dir</title>
          <style>body{font-family:monospace;background:#0a0a0a;color:#e0e0e0;max-width:600px;margin:2rem auto;padding:1rem}a{color:#00ff88}</style>
          </head><body>
          <h1>$ ls ./$dir</h1>
          <p><a href="../">‚Üê ..</a></p><ul>
          EOF
            for run in $(ls -dr "$dir"/2* 2>/dev/null | head -20); do
              echo "<li><a href=\"$(basename $run)/\">$(basename $run)/</a></li>" >> "$dir/index.html"
            done
            echo '</ul></body></html>' >> "$dir/index.html"
          done

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Add ${{ steps.info.outputs.dir }} report ${{ steps.info.outputs.timestamp }}"
          git push origin gh-pages --force
